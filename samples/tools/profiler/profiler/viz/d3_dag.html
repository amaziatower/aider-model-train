<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAG Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Include marked library -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            /* This line attempts to use system UI fonts:
            -apple-system and BlinkMacSystemFont for Apple systems,
            "Segoe UI" for Windows,
            Roboto for Android and some Chrome OS,
            "Helvetica Neue" for older macOS versions,
            Arial as a generic fallback,
            sans-serif as a final generic fallback. */
        }
        html, body {
            height: 100%; /* Full height for the html and body */
            margin: 0; /* Remove default margin */
            padding: 0; /* Remove default padding */
            display: flex; /* Enable flexbox */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
            background-color: #f4f4f4; /* Background color */
            box-sizing: border-box; /* Border and padding included in width/height */
        }
        #container {
            display: flex; /* Flex container for the panels */
            width: 90vw; /* 90% of viewport width */
            height: 90vh; /* 80% of viewport height */
            padding: 20px; /* Padding around the container */
            box-sizing: border-box; /* Include padding in the width and height calculation */
        }
        #left-panel {
            width: 40%;
            height: 100%; /* Full height of the container */
            overflow-y: auto;
            padding: 10px;
            border: 1px solid gray;
            border-radius: 10px;
            font-size: 12px;
            box-sizing: border-box;
            direction: rtl; /* Right to Left text direction for scrollbar */
        }
        #left-panel > * {
            direction: ltr; /* Left to Right text direction for contents */
        }
        #svg-container {
            flex: 1; /* Take remaining space */
            height: 100%; /* Full height of the container */
            margin-left: 2%; /* Gutter between panels */
            border: solid 1px black;
            border-radius: 10px;
            box-sizing: border-box;
            background-color: white; /* Ensure background is white for visibility */
        }
        #svg {
            width: 100%;
            height: 100%;
        }
        text {
            font-size: 14px;
            text-anchor: middle;
            pointer-events: none;
            fill: #333;
        }
        .link {
            stroke: #999;
            stroke-opacity: 0.6;
            stroke-width: 1.5px;
            fill: none;
            marker-end: url(#arrow);
        }
        .node circle {
            fill: #66c2a5;
            stroke: #333;
            stroke-width: 1.5px;
        }
        .node-info {
            margin-bottom: 10px;
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .node-info:hover {
            background-color: #eee;
        }
        .selected-message {
            outline: 2px solid blue;
        }

        .state-tags {
            display: flex; /* Flexbox to arrange tags in a row */
            flex-wrap: wrap; /* Allow wrapping onto the next line */
            gap: 5px; /* Space between tags */
            margin-top: 10px; /* Space above the tag container */
        }

        .state-tag {
            background-color: #007BFF; /* Blue background */
            color: white; /* White text */
            padding: 2px 8px; /* Padding inside the tag */
            border-radius: 10px; /* Rounded corners */
            font-size: 0.8em; /* Smaller font size for tags */
        }

    </style>
</head>
<body>
    <div id="container">
        <div id="left-panel">
            <!-- Node information will be populated here -->
        </div>
        <div id="svg-container">
            <svg id="svg"></svg>
        </div>
    </div>
    <script>
        let data = "__DAG_DATA__";

        const svg = d3.select("#svg");
        const svgContainer = d3.select("#svg-container");
        const width = svgContainer.node().getBoundingClientRect().width;
        const height = svgContainer.node().getBoundingClientRect().height;

        const zoom = d3.zoom()
            .scaleExtent([0.1, 10])
            .on("zoom", (event) => {
                container.attr("transform", event.transform);
            });

        svg.call(zoom);

        const container = svg.append("g");

        const link = container.selectAll(".link")
            .data(data.links)
            .enter().append("line")
            .attr("class", "link")
            .attr("marker-end", "url(#arrow)");

        const nodeRadius = 30;
        const simulation = d3.forceSimulation(data.nodes)
            .force("link", d3.forceLink(data.links).id(d => d.index).distance(100))
            .force("charge", d3.forceManyBody().strength(-300))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide(nodeRadius + 1));

        const node = container.selectAll(".node")
            .data(data.nodes)
            .enter().append("g")
            .attr("class", "node")
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended))
            .on("click", (event, d) => {
                const index = d.index;
                const nodeInfoElement = document.getElementById(`node-info-${index}`);
                if (nodeInfoElement) {
                    // Scroll to the corresponding message
                    nodeInfoElement.scrollIntoView({ behavior: "smooth", block: "start", inline: "nearest" });

                    // Remove outline from previously selected message
                    const previousSelected = document.querySelector(".selected-message");
                    if (previousSelected) {
                        previousSelected.classList.remove("selected-message");
                    }

                    // Add outline to the selected message
                    nodeInfoElement.classList.add("selected-message");
                }
            });

        node.append("circle")
            .attr("r", nodeRadius);

        node.append("text")
            .attr("dy", "0.35em")
            .text(d => d.profile.message.source);

        simulation.on("tick", () => {
            link.attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node.attr("transform", d => `translate(${d.x},${d.y})`);
        });

        // Add this function at the beginning of your script
        function processMarkdown(md) {
            md = md.replace(/>>>>>>>>/g, "**");
            md = md.replace(/\n/g, "\n\n");
            return md;
        }

        // Then modify the existing code
        const leftPanel = d3.select("#left-panel");
        const nodeInfo = leftPanel.selectAll(".node-info")
            .data(data.nodes)
            .enter().append("div")
            .attr("class", "node-info")
            .attr("id", (d, i) => `node-info-${i}`)
            .html(d => {
                let contentHtml = marked.parse(processMarkdown(d.profile.message.content));
                let statesHtml = '';

                if (d.profile.states && d.profile.states.length > 0) {
                    statesHtml += '<div class="state-tags">';
                    d.profile.states.forEach(state => {
                        statesHtml += `<span class="state-tag">${state.name}</span>`;
                    });
                    statesHtml += '</div>';
                }

                return contentHtml + statesHtml;
            });

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
    </script>
</body>
</html>
